<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bug Bounty System</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Monaco', 'Consolas', 'Courier New', monospace;
            background-color: #0a0a0a;
            color: #00ff41;
            line-height: 1.6;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 20px;
            border: 2px solid #00ff41;
            border-radius: 8px;
            background: #1a1a1a;
            position: relative;
        }
        .user-info {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 0.8em;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .user-avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 1px solid #00ff41;
        }
        .logout-btn {
            background: transparent;
            border: 1px solid #f44336;
            color: #f44336;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            text-decoration: none;
            font-size: 0.8em;
        }
        .logout-btn:hover {
            background: #f44336;
            color: #fff;
        }
        .nav {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
            gap: 20px;
            flex-wrap: wrap;
        }
        .nav-btn {
            padding: 15px 30px;
            background: #1a1a1a;
            border: 1px solid #00ff41;
            color: #00ff41;
            text-decoration: none;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
        }
        .nav-btn:hover {
            background: #00ff41;
            color: #000;
            transform: translateY(-2px);
        }
        .section {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 30px;
            margin-bottom: 30px;
        }
        .target-form {
            display: grid;
            gap: 20px;
            max-width: 500px;
            margin: 0 auto;
        }
        .form-group {
            display: flex;
            flex-direction: column;
        }
        .form-group label {
            color: #00ff41;
            margin-bottom: 8px;
            font-weight: bold;
        }
        .form-group input, .form-group textarea {
            background: #0a0a0a;
            border: 1px solid #333;
            color: #fff;
            padding: 12px;
            border-radius: 4px;
            font-family: inherit;
        }
        .form-group input:focus, .form-group textarea:focus {
            outline: none;
            border-color: #00ff41;
        }
        .btn {
            background: #00ff41;
            color: #000;
            border: none;
            padding: 15px 30px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            font-family: inherit;
            transition: all 0.3s;
        }
        .btn:hover {
            background: #00cc33;
            transform: translateY(-2px);
        }
        .target-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        .target-card {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 20px;
            transition: all 0.3s;
        }
        .target-card:hover {
            border-color: #00ff41;
            transform: translateY(-2px);
        }
        .target-card h3 {
            color: #00ff41;
            margin-bottom: 10px;
        }
        .scan-btn {
            background: #ff9800;
            color: #000;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            font-weight: bold;
            font-family: inherit;
            margin-top: 10px;
        }
        .success { color: #4caf50; }
        .warning { color: #ff9800; }
        .error { color: #f44336; }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
        }
        .stat-card h3 {
            color: #00ff41;
            margin-bottom: 10px;
        }
        .stat-card .number {
            font-size: 2em;
            font-weight: bold;
            color: #fff;
        }
        .hidden { display: none !important; }
        .loading {
            text-align: center;
            padding: 20px;
            color: #ff9800;
        }
        .terminal {
            background: #000;
            border: 1px solid #00ff41;
            padding: 20px;
            border-radius: 4px;
            font-family: monospace;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin: 20px 0;
        }
        .delete-btn {
            background: transparent;
            border: 1px solid #f44336;
            color: #f44336;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            font-family: inherit;
            margin-top: 10px;
            transition: all 0.3s;
        }
        .delete-btn:hover {
            background: #f44336;
            color: #fff;
        }
        .severity-critical { color: #ff1744; font-weight: bold; }
        .severity-high { color: #f44336; font-weight: bold; }
        .severity-medium { color: #ff9800; font-weight: bold; }
        .severity-low { color: #4caf50; }
        .severity-info { color: #2196f3; }
        .settings-section-title {
            color: #00ff41;
            margin-top: 25px;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid #333;
            font-size: 1.1em;
        }
        .report-card {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s;
        }
        .report-card:hover {
            border-color: #00ff41;
        }
        .scan-btn-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }
        .scan-btn-sm {
            background: #ff9800;
            color: #000;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            font-family: inherit;
            font-size: 0.85em;
            transition: all 0.3s;
        }
        .scan-btn-sm:hover {
            background: #ffb74d;
            transform: translateY(-1px);
        }
        .scan-btn-sm.free {
            background: #4caf50;
            color: #000;
        }
        .scan-btn-sm.free:hover {
            background: #66bb6a;
        }
        
        /* Login Page Styles */
        .login-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 60vh;
            text-align: center;
        }
        .google-btn {
            display: inline-flex;
            align-items: center;
            background: #fff;
            color: #444;
            padding: 10px 20px;
            border-radius: 4px;
            text-decoration: none;
            font-weight: bold;
            margin-top: 30px;
            transition: all 0.2s;
        }
        .google-btn:hover {
            box-shadow: 0 0 15px rgba(255,255,255,0.5);
            transform: translateY(-2px);
        }
        .google-icon {
            width: 20px;
            height: 20px;
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Auth Header (Hidden on Login) -->
        <div id="auth-header" class="header hidden">
            <h1>üöÄ Bug Bounty System</h1>
            <p>Professional Vulnerability Hunting Platform</p>
            <div id="user-info" class="user-info">
                <!-- User info will be injected here -->
            </div>
        </div>

        <!-- Navigation (Hidden on Login) -->
        <nav id="main-nav" class="nav hidden">
            <a href="#dashboard" class="nav-btn" onclick="showPage('dashboard')">Dashboard</a>
            <a href="#targets" class="nav-btn" onclick="showPage('targets')">Targets</a>
            <a href="#recon" class="nav-btn" onclick="showPage('recon')">Recon</a>
            <a href="#vulnerabilities" class="nav-btn" onclick="showPage('vulnerabilities')">Vulnerabilities</a>
            <a href="#reports" class="nav-btn" onclick="showPage('reports')">Reports</a>
            <a href="#settings" class="nav-btn" onclick="showPage('settings')">Settings</a>
        </nav>

        <!-- Login Page -->
        <div id="login-page" class="page section hidden">
            <div class="login-container">
                <h1 style="font-size: 3em; margin-bottom: 20px;">üîí ACCESS RESTRICTED</h1>
                <p>Authorized Personnel Only. Please authenticate to continue.</p>
                
                <a href="/api/auth/google" class="google-btn">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/5/53/Google_%22G%22_Logo.svg" alt="G" class="google-icon">
                    Sign in with Google
                </a>
                
                <div id="login-error" class="error hidden" style="margin-top: 20px;">
                    Authentication Failed. Please try again.
                </div>
            </div>
        </div>

        <!-- Dashboard Page -->
        <div id="dashboard" class="page section hidden">
            <h2>üìä Dashboard</h2>
            <div class="stats">
                <div class="stat-card">
                    <h3>Total Targets</h3>
                    <div class="number" id="total-targets">0</div>
                </div>
                <div class="stat-card">
                    <h3>Running Scans</h3>
                    <div class="number" id="running-scans">0</div>
                </div>
                <div class="stat-card">
                    <h3>Vulnerabilities Found</h3>
                    <div class="number" id="total-vulns">0</div>
                </div>
                <div class="stat-card">
                    <h3>Reports Generated</h3>
                    <div class="number" id="total-reports">0</div>
                </div>
            </div>
            <div style="text-align: center; margin-top: 30px;">
                <button class="btn" onclick="showPage('targets')">Add Your First Target</button>
            </div>
        </div>

        <!-- Targets Page -->
        <div id="targets" class="page section hidden">
            <h2>üéØ Targets</h2>
            <div class="target-form">
                <div class="form-group">
                    <label>Domain</label>
                    <input type="text" id="domain" placeholder="example.com" required>
                </div>
                <div class="form-group">
                    <label>Name (Optional)</label>
                    <input type="text" id="name" placeholder="Target Name">
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="description" rows="3" placeholder="Target description"></textarea>
                </div>
                <button class="btn" onclick="addTarget()">Add Target</button>
            </div>
            <h3 style="margin-top: 40px;">Current Targets</h3>
            <div id="target-list" class="target-list"></div>
        </div>

        <!-- Recon Page -->
        <div id="recon" class="page section hidden">
            <h2>üîç Reconnaissance</h2>
            <div id="recon-targets" class="target-list"></div>
        </div>

        <!-- Vulnerabilities Page -->
        <div id="vulnerabilities" class="page section hidden">
            <h2>üêõ Vulnerabilities</h2>
            <div id="vuln-list">
                <p style="text-align: center; color: #666;">No vulnerabilities found yet. Run reconnaissance to discover security issues.</p>
            </div>
        </div>

        <!-- Reports Page -->
        <div id="reports" class="page section hidden">
            <h2>üìÑ Reports</h2>
            <div id="report-targets" style="margin-bottom: 20px;"></div>
            <h3 style="margin-top: 20px;">Generated Reports</h3>
            <div id="report-list"></div>
        </div>

        <!-- Settings Page -->
        <div id="settings" class="page section hidden">
            <h2>‚öôÔ∏è API Settings</h2>
            <div class="target-form">
                <h4 class="settings-section-title">Primary OSINT APIs</h4>
                <div class="form-group">
                    <label>Shodan API Key</label>
                    <input type="password" id="shodan_api_key" placeholder="Enter Shodan API Key">
                </div>
                <div class="form-group">
                    <label>SecurityTrails API Key</label>
                    <input type="password" id="securitytrails_api_key" placeholder="Enter SecurityTrails API Key">
                </div>
                <div class="form-group">
                    <label>VirusTotal API Key</label>
                    <input type="password" id="virustotal_api_key" placeholder="Enter VirusTotal API Key">
                </div>

                <h4 class="settings-section-title">Additional OSINT APIs</h4>
                <div class="form-group">
                    <label>AlienVault OTX API Key <span style="color:#4caf50">(works without key)</span></label>
                    <input type="password" id="alienvault_api_key" placeholder="Optional ‚Äî works without key">
                </div>
                <div class="form-group">
                    <label>Censys API ID</label>
                    <input type="password" id="censys_api_id" placeholder="Enter Censys API ID">
                </div>
                <div class="form-group">
                    <label>Censys API Secret</label>
                    <input type="password" id="censys_api_secret" placeholder="Enter Censys API Secret">
                </div>
                <div class="form-group">
                    <label>NIST NVD API Key <span style="color:#4caf50">(works without key)</span></label>
                    <input type="password" id="nvd_api_key" placeholder="Optional ‚Äî works without key">
                </div>

                <h4 class="settings-section-title">Utility APIs</h4>
                <div class="form-group">
                    <label>HackerTarget API Key <span style="color:#4caf50">(works without key)</span></label>
                    <input type="password" id="hackertarget_api_key" placeholder="Optional ‚Äî works without key">
                </div>
                <div class="form-group">
                    <label>Hunter.io API Key</label>
                    <input type="password" id="hunter_api_key" placeholder="Enter Hunter.io API Key">
                </div>
                <div class="form-group">
                    <label>WHOIS API Key <span style="color:#4caf50">(works without key)</span></label>
                    <input type="password" id="whois_api_key" placeholder="Optional ‚Äî works without key">
                </div>

                <button class="btn" onclick="saveSettings()">Save Settings</button>
                <div id="settings-status" style="margin-top: 10px; text-align: center;"></div>
            </div>
        </div>

        <!-- Scan Output Modal -->
        <div id="scan-modal" class="section hidden" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 1000;">
            <div style="position: relative; max-width: 800px; margin: 50px auto; background: #1a1a1a; padding: 30px; border-radius: 8px;">
                <h3 style="color: #00ff41;">Scan Output</h3>
                <div id="scan-output" class="terminal"></div>
                <button class="btn" onclick="closeScanModal()" style="margin-top: 20px;">Close</button>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        // ============================================================
        // API Configuration
        // ============================================================
        const API = '';
        const FETCH_OPTS = { credentials: 'include' };

        async function apiFetch(path, opts = {}) {
            const url = path.startsWith('http') ? path : API + path;
            const options = {
                ...FETCH_OPTS,
                ...opts,
                headers: { 'Content-Type': 'application/json', ...(opts.headers || {}) }
            };
            if (opts.noContentType) {
                delete options.headers['Content-Type'];
                delete options.noContentType;
            }
            return fetch(url, options);
        }

        // ============================================================
        // State
        // ============================================================
        let targets = [];
        let currentScan = null;
        let currentUser = null;
        let scanSocket = null;

        // ============================================================
        // Init
        // ============================================================
        document.addEventListener('DOMContentLoaded', function() {
            checkAuth();
        });

        // ============================================================
        // Authentication
        // ============================================================
        async function checkAuth() {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('error')) {
                document.getElementById('login-error').classList.remove('hidden');
            }

            try {
                const healthRes = await apiFetch('/api/health');
                const healthData = await healthRes.json();

                if (healthData.auth_enabled) {
                    const authRes = await apiFetch('/api/auth/current_user');
                    const user = await authRes.json();
                    if (user) {
                        currentUser = user;
                        showApp(user);
                    } else {
                        showLogin();
                    }
                } else {
                    showLogin(true);
                }
            } catch (e) {
                console.error('Auth check failed', e);
                showLogin();
            }
        }

        function showLogin(isDev = false) {
            document.querySelectorAll('.page').forEach(el => el.classList.add('hidden'));
            document.getElementById('auth-header').classList.add('hidden');
            document.getElementById('main-nav').classList.add('hidden');

            const loginPage = document.getElementById('login-page');
            loginPage.classList.remove('hidden');

            if (isDev && !loginPage.querySelector('button[onclick="bypassLogin()"]')) {
                const devMsg = document.createElement('p');
                devMsg.innerHTML = '<br><span style="color: #ff9800">[DEV MODE] Backend Auth keys missing.<br><button class="btn" onclick="bypassLogin()">Bypass Login</button></span>';
                loginPage.querySelector('.login-container').appendChild(devMsg);
            }
        }

        function bypassLogin() {
            currentUser = { displayName: 'Dev User', photo: '' };
            showApp(currentUser);
        }

        async function showApp(user) {
            document.getElementById('login-page').classList.add('hidden');
            document.getElementById('auth-header').classList.remove('hidden');
            document.getElementById('main-nav').classList.remove('hidden');

            const userInfo = document.getElementById('user-info');
            userInfo.innerHTML = `
                ${user.photo ? `<img src="${user.photo}" class="user-avatar">` : ''}
                <span>${user.displayName || 'Hunter'}</span>
                <a href="/api/auth/logout" class="logout-btn">Logout</a>
            `;

            // Load targets from backend, then show dashboard
            await fetchTargets();
            updateDashboard();
            document.getElementById('dashboard').classList.remove('hidden');
        }

        // ============================================================
        // Navigation
        // ============================================================
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
            document.getElementById(pageId).classList.remove('hidden');

            if (pageId === 'dashboard') updateDashboard();
            if (pageId === 'targets') renderTargets();
            if (pageId === 'recon') renderReconTargets();
            if (pageId === 'vulnerabilities') renderVulnerabilities();
            if (pageId === 'reports') renderReports();
            if (pageId === 'settings') loadSettings();
        }

        // ============================================================
        // Targets ‚Äî CRUD via API
        // ============================================================
        async function fetchTargets() {
            try {
                const res = await apiFetch('/api/targets');
                if (res.ok) targets = await res.json();
            } catch (e) {
                console.error('Failed to fetch targets', e);
            }
        }

        async function addTarget() {
            const domain = document.getElementById('domain').value.trim();
            const name = document.getElementById('name').value.trim();
            const description = document.getElementById('description').value.trim();

            if (!domain) { alert('Please enter a domain'); return; }

            try {
                const res = await apiFetch('/api/targets', {
                    method: 'POST',
                    body: JSON.stringify({ domain, name: name || domain, description })
                });

                if (res.ok) {
                    document.getElementById('domain').value = '';
                    document.getElementById('name').value = '';
                    document.getElementById('description').value = '';
                    await fetchTargets();
                    renderTargets();
                    updateDashboard();
                } else {
                    const err = await res.json();
                    alert('Failed to add target: ' + (err.error || res.statusText));
                }
            } catch (e) {
                alert('Error adding target: ' + e.message);
            }
        }

        async function deleteTarget(id) {
            if (!confirm('Delete this target?')) return;
            try {
                await apiFetch(`/api/targets/${id}`, { method: 'DELETE' });
                await fetchTargets();
                renderTargets();
                updateDashboard();
            } catch (e) {
                alert('Error deleting target: ' + e.message);
            }
        }

        function renderTargets() {
            const container = document.getElementById('target-list');
            if (targets.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">No targets added yet. Add your first target above!</p>';
                return;
            }
            container.innerHTML = targets.map(t => `
                <div class="target-card">
                    <h3>${t.name || t.domain}</h3>
                    <p><strong>Domain:</strong> ${t.domain}</p>
                    ${t.description ? `<p><strong>Description:</strong> ${t.description}</p>` : ''}
                    <p><strong>Status:</strong> <span class="success">${t.status || 'active'}</span></p>
                    <p><strong>Added:</strong> ${new Date(t.created_at || t.created).toLocaleDateString()}</p>
                    <button class="scan-btn" onclick="runScan('${t.id}', 'passive')">Passive Recon</button>
                    <button class="scan-btn" onclick="runScan('${t.id}', 'active')">Active Recon</button>
                    <button class="delete-btn" onclick="deleteTarget('${t.id}')">Delete</button>
                </div>
            `).join('');
        }

        // ============================================================
        // Recon Page ‚Äî All 12 scan types
        // ============================================================
        function renderReconTargets() {
            const container = document.getElementById('recon-targets');
            if (targets.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">No targets available. Add targets first!</p>';
                return;
            }
            container.innerHTML = targets.map(t => `
                <div class="target-card">
                    <h3>${t.name || t.domain}</h3>
                    <p><strong>Domain:</strong> ${t.domain}</p>
                    <div class="scan-btn-grid">
                        <button class="scan-btn-sm" onclick="runScan('${t.id}', 'passive')">Passive Recon</button>
                        <button class="scan-btn-sm" onclick="runScan('${t.id}', 'active')">Active Recon</button>
                        <button class="scan-btn-sm" onclick="runScan('${t.id}', 'shodan')">Shodan</button>
                        <button class="scan-btn-sm" onclick="runScan('${t.id}', 'dns')">Deep DNS</button>
                        <button class="scan-btn-sm" onclick="runScan('${t.id}', 'quick-scan')">Quick Vuln</button>
                        <button class="scan-btn-sm" onclick="runScan('${t.id}', 'virustotal')">VirusTotal</button>
                        <button class="scan-btn-sm free" onclick="runScan('${t.id}', 'alienvault')">AlienVault</button>
                        <button class="scan-btn-sm" onclick="runScan('${t.id}', 'censys')">Censys</button>
                        <button class="scan-btn-sm" onclick="runScan('${t.id}', 'vulnintel')">Vuln Intel</button>
                        <button class="scan-btn-sm free" onclick="runScan('${t.id}', 'hackertarget')">HackerTarget</button>
                        <button class="scan-btn-sm" onclick="runScan('${t.id}', 'hunter')">Hunter.io</button>
                        <button class="scan-btn-sm free" onclick="runScan('${t.id}', 'whois')">WHOIS</button>
                    </div>
                </div>
            `).join('');
        }

        // ============================================================
        // Scan Execution + Socket.IO
        // ============================================================
        async function runScan(targetId, scanType) {
            const target = targets.find(t => t.id === targetId);
            if (!target) { alert('Target not found'); return; }

            currentScan = { targetId, scanType, target };
            document.getElementById('scan-modal').classList.remove('hidden');
            const output = document.getElementById('scan-output');
            output.textContent = `[*] Starting ${scanType} scan for ${target.domain}...\n`;

            try {
                const res = await apiFetch(`/api/recon/${scanType}/${targetId}`, { method: 'POST' });

                if (res.ok) {
                    const result = await res.json();
                    appendScanOutput(`[+] Scan started ‚Äî Job ID: ${result.jobId}\n`);
                    connectScanSocket(result.jobId);
                } else {
                    const err = await res.json().catch(() => ({}));
                    appendScanOutput(`[-] Failed to start scan: ${err.error || res.statusText}\n`);
                }
            } catch (error) {
                appendScanOutput(`[-] Error: ${error.message}\n`);
            }
        }

        function connectScanSocket(jobId) {
            // Disconnect previous if any
            if (scanSocket) {
                scanSocket.disconnect();
                scanSocket = null;
            }

            try {
                scanSocket = io({ transports: ['websocket', 'polling'] });

                scanSocket.on('connect', () => {
                    appendScanOutput(`[*] Connected to scan stream\n`);
                    scanSocket.emit('join-target', jobId);
                });

                scanSocket.on('scan-update', (data) => {
                    const msg = typeof data === 'string' ? data : JSON.stringify(data);
                    appendScanOutput(`    ${msg}\n`);
                });

                scanSocket.on('scan-complete', (data) => {
                    appendScanOutput(`\n[+] Scan complete!\n`);
                    if (data && typeof data === 'object') {
                        appendScanOutput(`[+] Results: ${JSON.stringify(data, null, 2)}\n`);
                    }
                    scanSocket.disconnect();
                    scanSocket = null;
                });

                scanSocket.on('scan-error', (error) => {
                    const msg = typeof error === 'string' ? error : JSON.stringify(error);
                    appendScanOutput(`\n[-] Scan error: ${msg}\n`);
                    scanSocket.disconnect();
                    scanSocket = null;
                });

                scanSocket.on('connect_error', (err) => {
                    appendScanOutput(`[-] Socket connection error: ${err.message}\n`);
                });
            } catch (e) {
                appendScanOutput(`[-] Socket init failed: ${e.message}\n`);
            }
        }

        function appendScanOutput(text) {
            const output = document.getElementById('scan-output');
            output.textContent += text;
            output.scrollTop = output.scrollHeight;
        }

        function closeScanModal() {
            document.getElementById('scan-modal').classList.add('hidden');
            if (scanSocket) { scanSocket.disconnect(); scanSocket = null; }
            currentScan = null;
        }

        // ============================================================
        // Dashboard ‚Äî Live counts from API
        // ============================================================
        async function updateDashboard() {
            try {
                const [targetsRes, vulnsRes, reportsRes, jobsRes] = await Promise.all([
                    apiFetch('/api/targets'),
                    apiFetch('/api/vulnerabilities'),
                    apiFetch('/api/reports'),
                    apiFetch('/api/recon/jobs')
                ]);

                const tData = targetsRes.ok ? await targetsRes.json() : [];
                const vData = vulnsRes.ok ? await vulnsRes.json() : [];
                const rData = reportsRes.ok ? await reportsRes.json() : [];
                const jData = jobsRes.ok ? await jobsRes.json() : [];

                const runningScans = Array.isArray(jData)
                    ? jData.filter(j => j.status === 'running' || j.status === 'started').length
                    : 0;

                document.getElementById('total-targets').textContent = Array.isArray(tData) ? tData.length : 0;
                document.getElementById('total-vulns').textContent = Array.isArray(vData) ? vData.length : 0;
                document.getElementById('total-reports').textContent = Array.isArray(rData) ? rData.length : 0;
                document.getElementById('running-scans').textContent = runningScans;
            } catch (e) {
                console.error('Dashboard update failed', e);
            }
        }

        // ============================================================
        // Vulnerabilities ‚Äî From API
        // ============================================================
        async function renderVulnerabilities() {
            const container = document.getElementById('vuln-list');
            container.innerHTML = '<p class="loading">Loading vulnerabilities...</p>';

            try {
                const res = await apiFetch('/api/vulnerabilities');
                if (!res.ok) throw new Error(res.statusText);
                const vulns = await res.json();

                if (!vulns.length) {
                    container.innerHTML = '<p style="text-align: center; color: #666;">No vulnerabilities found yet. Run reconnaissance to discover security issues.</p>';
                    return;
                }

                container.innerHTML = `<div class="target-list">${vulns.map(v => {
                    const sev = (v.severity || 'info').toLowerCase();
                    return `
                        <div class="target-card">
                            <h3>${v.title || 'Untitled'}</h3>
                            <p><strong>Target:</strong> ${v.target_domain || v.target_id || 'Unknown'}</p>
                            <p><strong>Severity:</strong> <span class="severity-${sev}">${v.severity || 'Info'}</span></p>
                            <p><strong>Status:</strong> ${v.status || 'open'}</p>
                            ${v.description ? `<p><strong>Description:</strong> ${v.description}</p>` : ''}
                            <p><strong>Found:</strong> ${new Date(v.created_at || v.created).toLocaleDateString()}</p>
                        </div>
                    `;
                }).join('')}</div>`;
            } catch (e) {
                container.innerHTML = `<p class="error">Failed to load vulnerabilities: ${e.message}</p>`;
            }
        }

        // ============================================================
        // Reports ‚Äî Generate + List + Download
        // ============================================================
        async function renderReports() {
            // Show generate buttons per target
            const targetsDiv = document.getElementById('report-targets');
            if (targets.length === 0) {
                targetsDiv.innerHTML = '<p style="color: #666;">No targets. Add targets first to generate reports.</p>';
            } else {
                targetsDiv.innerHTML = `<h3>Generate Report</h3>` + targets.map(t => `
                    <div style="display: inline-block; margin: 5px;">
                        <button class="scan-btn" onclick="generateReport('${t.id}', '${t.name || t.domain}')">${t.name || t.domain}</button>
                    </div>
                `).join('');
            }

            // List existing reports
            const listDiv = document.getElementById('report-list');
            listDiv.innerHTML = '<p class="loading">Loading reports...</p>';

            try {
                const res = await apiFetch('/api/reports');
                if (!res.ok) throw new Error(res.statusText);
                const reports = await res.json();

                if (!reports.length) {
                    listDiv.innerHTML = '<p style="text-align: center; color: #666;">No reports generated yet. Click a target above to generate one.</p>';
                    return;
                }

                listDiv.innerHTML = reports.map(r => `
                    <div class="report-card">
                        <h3>${r.title || 'Report'}</h3>
                        <p><strong>Target:</strong> ${r.target_domain || r.target_id || 'Unknown'}</p>
                        <p><strong>Status:</strong> ${r.status || 'completed'}</p>
                        <p><strong>Created:</strong> ${new Date(r.created_at || r.created).toLocaleDateString()}</p>
                        <a href="${API}/api/reports/${r.id}/export?format=pdf" target="_blank" class="scan-btn" style="display:inline-block; text-decoration:none; margin-top:10px;">Download PDF</a>
                        <a href="${API}/api/reports/${r.id}/export?format=json" target="_blank" class="scan-btn" style="display:inline-block; text-decoration:none; margin-top:10px; background:#2196f3;">Download JSON</a>
                    </div>
                `).join('');
            } catch (e) {
                listDiv.innerHTML = `<p class="error">Failed to load reports: ${e.message}</p>`;
            }
        }

        async function generateReport(targetId, targetName) {
            try {
                const res = await apiFetch(`/api/reports/generate/${targetId}`, {
                    method: 'POST',
                    body: JSON.stringify({ template: 'standard' })
                });
                if (res.ok) {
                    alert(`Report generated for ${targetName}!`);
                    renderReports();
                } else {
                    const err = await res.json().catch(() => ({}));
                    alert('Failed to generate report: ' + (err.error || res.statusText));
                }
            } catch (e) {
                alert('Error generating report: ' + e.message);
            }
        }

        // ============================================================
        // Settings ‚Äî All 10 API keys
        // ============================================================
        const SETTINGS_KEYS = [
            'shodan_api_key', 'securitytrails_api_key', 'virustotal_api_key',
            'alienvault_api_key', 'censys_api_id', 'censys_api_secret',
            'nvd_api_key', 'hackertarget_api_key', 'hunter_api_key', 'whois_api_key'
        ];

        async function loadSettings() {
            try {
                const res = await apiFetch('/api/settings');
                if (res.ok) {
                    const settings = await res.json();
                    SETTINGS_KEYS.forEach(key => {
                        const el = document.getElementById(key);
                        if (el && settings[key]) el.value = settings[key];
                    });
                }
            } catch (e) {
                console.error('Failed to load settings', e);
            }
        }

        async function saveSettings() {
            const data = {};
            SETTINGS_KEYS.forEach(key => {
                const el = document.getElementById(key);
                if (el) data[key] = el.value;
            });

            // Filter out masked values that user didn't change
            const filtered = {};
            for (const [k, v] of Object.entries(data)) {
                if (v && !v.startsWith('****')) {
                    filtered[k] = v;
                }
            }

            if (Object.keys(filtered).length === 0) {
                alert('No changes to save.');
                return;
            }

            try {
                const res = await apiFetch('/api/settings', {
                    method: 'POST',
                    body: JSON.stringify(filtered)
                });
                const statusEl = document.getElementById('settings-status');
                if (res.ok) {
                    statusEl.innerHTML = '<span class="success">Settings saved successfully!</span>';
                    setTimeout(() => { statusEl.innerHTML = ''; }, 3000);
                } else {
                    statusEl.innerHTML = '<span class="error">Failed to save settings.</span>';
                }
            } catch (e) {
                alert('Error saving settings: ' + e.message);
            }
        }
    </script>
</body>
</html>